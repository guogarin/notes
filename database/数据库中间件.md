[toc]






&emsp;
&emsp; 
# 1. 数据库中间件(Database Middleware)基础
## 1.1 什么是中间件？
&emsp;&emsp; **数据库中间件** 处于底层数据库 和 用户应用系统 之间，主要用于屏蔽异构数据库的底层细节的中间件。是客户端与后台的数据库之间进行通信的桥梁。
&emsp;&emsp; 中间件是介于应用系统和系统软件之间的一类软件，它使用系统软件所提供的基础服务（功能），衔接网络上应用系统的各个部分或不同的应用，能够达到资源共享、功能共享的目的。它并没有很严格的定义，但是普遍接受IDC的定义：
> &emsp;&emsp; 中间件是一种独立的系统软件服务程序，分布式应用软件借助这种软件在不同的技术之间共享资源，中间件位于客户机服务器的操作系统之上，管理计算资源和网络通信。从这个意义上可以用一个等式来表示中间件：中间件=平台+通信，这也就限定了只有用于分布式系统中才能叫中间件，同时也把它与支撑软件和实用软件区分开来。
> 

## 1.2 中间件的作用是？
当出现下列问题时:
> ① 数据库存储的量不是很大，但并发的读写操作很大时，且超过数据库的处理能力了。
> ② 应用的业务模块很多，总的数据量很大，并发的处理操作均超过单个数据库服务器的处理能力。
> ③ 如果单个表的数据量很大，超过了单表的存储上限，如商品表、订单表等。
> 
此时，为了解决数据存储、访问性能我们需要用到数据库中间件。数据库中间件可以让我们在应用程序中快速的应用读写分离、分库分表，并且如果要是想让我们写代码时不需要关注数据库是不是进行了读写分离，所以需要隔离这些下端的数据库读写分离带来的变化屏蔽掉对上端的影响，就需要加数据库访问模块即数据库中间件。

## 1.3 数据库中间件分类
### 1.3.1 有哪些中间件？
数据库中间件有以下4种：
| 数据库中间件分类               |
| ------------------------------ |
| ① 分表分库中间件               |
| ② 数据增量订阅与消费中间件     |
| ③ 数据库同步中间件             |
| ④ 跨数据库（数据源）迁移中间件 |

### 1.3.2 分表分库中间件              
&emsp;&emsp; 分布式数据库 分表分库中间件，负责和上层应用打交道，对应用可表现为一个独立的数据库，而屏蔽底层复杂的系统细节。分布式数据库中间件除了基本的分表分库功能，还可以丰富一下，比如讲读写分离或者水平扩容功能集成在一起，或者比如读写分离本身也可以作为一个独立的中间件。（Cobar, MyCAT, TDDL, DRDS, DDB）
分表分库类的中间件主要有两种形式向应用提供服务：
> ① 一种是以JDBC的jar包形式为Java应用提供直接依赖，Java应用通过提供的JDBC包实现透明访问分布式数据库集群中的各个分库分表，典型代表网易的DDB和阿里的TDDL.
> ② 另一种是为应用部署独立的服务来满足应用分库分表的需求，在这种方式下通过标准JDBC访问Proxy，而Proxy则根据MySQL标准通信协议对客户端请求解析，还原应用SQL请求，然后通过本地访问数据库集群，最后再将得到的结果根据MySQL标准通信协议编码返回给客户端。
> 
典型代表是阿里的`Cobar`，`Cobar`变种`MyCAT`，阿里的`DRDS`，网易的`DDB proxy`模式以及`DDB`的私有云模式。

### 1.3.2 数据增量订阅与消费中间件    
&emsp;&emsp; 增量数据订阅和消费、用户对数据库操作，比如`DML, DCL, DDL`等，这些操作会产生增量数据，下层应用可以通过监测这些增量数据进行相应的处理。这个是基于对数据库增量日志解析，提供增量数据订阅和消费；最有名的是阿里的 `Canal`。根据`MySQL`的`binlog`实现，`Canal` 通过监听 `Mysql` 的 `binlog` 日志来获取数据，`binlog` 设置为 `row` 模式，能够获取到每一条新增、删除、修改的日志，同时还能获取到修改前后的数据。通常我们可以利用这个中间件，实时感知到 `Mysql` 中的数据变化，将其数据更新到 `NoSQL` 数据中，比如 `MongoDB``、ES` 等等；通常项目组加入这些非关系数据库，可以减轻数据库查询压力、在分库分表的架构中，还能起到全局查询的作用。
&emsp;&emsp; 市面上也有针对`Oracle(redolog)`的增量数据订阅与消费的中间件：`Canal`, `Erosa`

### 1.3.3 数据库同步中间件            
&emsp;&emsp; 数据库同步中间件涉及数据库之间的同步操作，可以实现 跨/同 机房同步以及异地容灾备份、分流等功能。可以涉及多种数据库，处理之后的数据也可以以多种形式存储。常见的有：`Otter`, `JingoBus`, `DRC`等

### 1.3.4 跨数据库（数据源）迁移中间件
&emsp;&emsp; 数据库与数据库之间会有数据迁移（同步）的动作，同款数据同步原理比较简单，比如`MySQL`主备同步，只要在数据库层进行相应的配置既可；但是跨数据库同步就比较复杂了，比如`Oracle->MySQL`。 数据迁移一般包括三个步骤：
> ① 全量复制，将原数据库的数据全量迁移到新数据库，在这迁移的过程中也会有新的数据产生；
> ② 增量同步，对新产生的数据进行同步，并持续一段时间以保证数据同步；
> ③ 原库停写，切换新库。
> 
跨数据库（数据源）迁移中间件 有 `yugong`和`DataX`等。



## 1.4 有哪些常见的数据库中间件工具？
常见的数据库中间件工具
**(1) Cobar**
&emsp;&emsp; 阿里开源的关系型数据库分布式服务中间件，已停更

**(2) DRDS**
&emsp;&emsp; 分布式关系型数据库服务（Distribute Relational Database Service，简称DRDS），也是阿里开发的，是一种水平拆分、可平滑扩缩容、读写分离的在线分布式数据库服务。整合云服务，收费、Cobar、TDDL整合。

**(3) MyCat**
开源数据库中间件，有如下特点：
> ① 遵守Mysql原生协议，跨语言，跨数据库的通用中间件代理。
> ② 基于心跳的自动故障切换，支持读写分离，支持 MySQL 一双主多从，以及一主多从
> ③ 有效管理数据源连接，基于数据分库，而不是分表的模式。
> 

**(4) Atlas**
`Atlas` 是由 360 Web平台部基础架构团队开发维护的一个基于 MySQL 协议的数据中间层项目。它是在`mysql-proxy 0.8.2`版本的基础上，对其进行了优化，增加了一些新的功能特性。360内部使用 `Atlas` 运行的 MySQL 务，每天承载的读写请求数达几十亿条。主要功能有：
> ① 读写分离
> ② 从库负载均衡
> ③ IP过滤
> ④ SQL语句黑白名单
> ⑤ 自动分表
> 

**(5) OneProxy**
&emsp;&emsp; `OneProxy` 分布式中间件，是平民软件完全自主开发的分布式数据访问层，帮助用户在 `MySQL/PostgreSQL` 集群上快速搭建支持分库分表的分布式数据库中间件，也是一款具有 SQL白名单（防 SQL 注入）及 IP 白名单功能的 SQL 防火墙软件。采用与 MySQL Proxy 一致的反向协议输出模式，对应用非常简单和透明易用，让用户畏惧的分库分表（Horizontal Partitioning）工作变得极其简单可控。基于 Libevent 机制实现，单个实例可以实现25万的 SQL 转发能力，用一个 OneProxy 节点可以带动整个 MySQL 集群。





# 参考文献
1. [数据库中间件详解](https://zhuanlan.zhihu.com/p/87144535)
